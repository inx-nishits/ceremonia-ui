<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Interview - CeremonIA</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../../assets/images/favicon/favicon.png">
    <link rel="apple-touch-icon" href="../../assets/images/favicon/favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../assets/js/tailwind.config.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Montserrat:wght@300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/main.css">
</head>

<body class="bg-cream h-screen overflow-hidden text-charcoal">

    <div class="flex flex-col md:flex-row h-screen">

        <!-- LEFT SIDEBAR: Summary Panel -->
        <aside
            class="w-full md:w-80 bg-white border-r border-beige flex flex-col z-30 shadow-lg md:shadow-none order-2 md:order-1 md:h-screen">
            <div class="p-8 border-b border-beige hidden md:block shrink-0">
                <a href="../../index.html" class="block">
                    <img src="../../assets/images/approved-logo.svg" alt="CeremonIA" class="h-12 w-auto">
                </a>
            </div>

            <div class="p-8 flex-grow overflow-y-auto">
                <h3 class=" text-xs uppercase tracking-[0.2em] text-taupe mb-6">Your Progress</h3>

                <!-- Progress Bar in Sidebar -->
                <div class="mb-8">
                    <div class="flex justify-between text-xs mb-2">
                        <span class="text-charcoal font-semibold">Completion</span>
                        <span id="sidebar-progress-text" class="text-plum">0%</span>
                    </div>
                    <div class="h-1 bg-border w-full rounded-full overflow-hidden">
                        <div id="sidebar-progress-bar" class="h-full bg-plum transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Steps List -->
                <div id="sidebar-steps" class="space-y-6 relative">
                    <!-- Populated by JS -->
                    <!-- Dotted Line -->
                    <div class="absolute left-[15px] top-2 bottom-2 w-px bg-border -z-10"></div>
                </div>
            </div>

            <!-- Footer in Sidebar -->
            <div class="px-4 py-3 border-t border-beige hidden md:block shrink-0">
                <a href="../../index.html"
                    class="flex items-center justify-center gap-2 text-taupe hover:text-plum transition-colors text-xs uppercase tracking-widest px-8 py-4 border border-beige hover:border-plum rounded">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Home
                </a>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col relative order-1 md:order-2 md:h-screen overflow-y-auto bg-cream">
            <!-- Mobile Header (Logo) -->
            <div
                class="md:hidden p-4 flex justify-between items-center bg-white border-b border-beige sticky top-0 z-20 shrink-0">
                <img src="../../assets/images/approved-logo.svg" alt="CeremonIA" class="h-8 w-auto">
                <span id="mobile-progress" class="text-xs text-plum font-bold">0%</span>
            </div>

            <div class="max-w-3xl w-full mx-auto p-6 md:p-12 lg:p-20 flex-grow pb-32">
                <!-- Block Header -->
                <div id="block-header" class="mb-12 animate-[fadeInUp_0.5s_ease-out]">
                    <!-- Populated by JS -->
                </div>

                <!-- Questions List -->
                <div id="inputs-container" class="space-y-12">
                    <!-- Questions and Inline Inputs Populated by JS -->
                </div>
            </div>

            <!-- Navigation Footer -->
            <div
                class="bg-white/90 backdrop-blur py-2 px-4 sticky bottom-0 z-20 flex justify-between items-center shrink-0">
                <button id="back-button" onclick="goToPreviousBlock()"
                    class=" text-xs uppercase tracking-[0.2em] text-taupe hover:text-charcoal transition-colors disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-2 px-8 py-4 border border-transparent hover:border-beige rounded">
                    <span class="text-lg">←</span> Previous
                </button>
                <button id="next-button" onclick="goToNextBlock()"
                    class="bg-plum text-white  text-xs uppercase tracking-[0.2em] px-8 py-4 hover:bg-plum-light transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed rounded">
                    Next Block
                </button>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/validation.js"></script>
    <script>
        // --- DATA & CONFIG ---
        const questionnaireBlocks = [
            {
                id: 1,
                title: "General Information",
                instruction: "Let's start with the basics. These details help us structure the ceremony.",
                isLocked: false,
                questions: [
                    { id: 'coupleName', text: 'What are your names?', type: 'text', required: true, placeholder: 'e.g., Sarah & James' },
                    { id: 'ceremonyName', text: 'How should we title the ceremony?', type: 'text', required: true, placeholder: 'e.g., The Union of Sarah & James' },
                    { id: 'ceremonyDate', text: 'When is the ceremony taking place?', type: 'text', required: true, placeholder: 'e.g., June 15, 2025' }
                ]
            },
            {
                id: 2,
                title: "Personal Details",
                instruction: "Tell us a bit about your journey.",
                isLocked: false,
                questions: [
                    { id: 'ceremonyLocation', text: 'Where will the ceremony take place?', type: 'text', required: true, placeholder: 'e.g., A vineyard in Tuscany' },
                    { id: 'meetStory', text: 'How did you meet? Tell us the story.', type: 'textarea', required: true, placeholder: 'It all started when...' },
                    { id: 'sharedHobby', text: 'What is a passion you both share?', type: 'text', required: true, placeholder: 'e.g., Hiking, Cooking, Travel' }
                ]
            },
            {
                id: 3,
                title: "Connection",
                instruction: "Dive deeper into your bond.",
                isLocked: false,
                questions: [
                    { id: 'connection', text: 'What specific moment made you realize this was "it"?', type: 'textarea', required: true, placeholder: 'There was this moment when...' }
                ]
            },
            {
                id: 4,
                title: "Values",
                instruction: "What grounds your relationship?",
                isLocked: false,
                questions: [
                    { id: 'values', text: 'What core values guide your relationship?', type: 'textarea', required: true, placeholder: 'Trust, Adventure, Kindness...' }
                ]
            },
            {
                id: 5,
                title: "Future",
                instruction: "Look ahead to your life together.",
                isLocked: false,
                questions: [
                    { id: 'future', text: 'What are your dreams for the future?', type: 'textarea', required: true, placeholder: 'We hope to build...' }
                ]
            }
        ];

        let currentBlockIndex = 0;
        let activeQuestionId = null; // Which question is currently showing an input
        let editingQuestionId = null; // Specifically for editing a past answer

        // --- SPEECH RECOGNITION ---
        let recognition = null;
        let isListening = false;
        let listeningTargetId = null;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    if (listeningTargetId) {
                        const input = document.getElementById(listeningTargetId);
                        if (input) {
                            input.value = (input.value ? input.value + ' ' : '') + transcript;
                            // Trigger input event for char count
                            input.dispatchEvent(new Event('input'));
                        }
                    }
                    isListening = false;
                    updateVoiceUI();
                };

                recognition.onerror = function () { isListening = false; updateVoiceUI(); };
                recognition.onend = function () { isListening = false; updateVoiceUI(); };
            }
        }

        function toggleVoiceInput(targetId) {
            if (!recognition) { alert('Voice input not supported.'); return; }
            if (isListening) {
                recognition.stop();
                isListening = false;
                listeningTargetId = null;
            } else {
                listeningTargetId = targetId;
                recognition.start();
                isListening = true;
            }
            updateVoiceUI();
        }

        function updateVoiceUI() {
            // Find all voice buttons and reset/activate
            document.querySelectorAll('.voice-btn').forEach(btn => {
                const targetId = btn.dataset.target;
                if (isListening && targetId === listeningTargetId) {
                    btn.classList.add('text-red-600', 'animate-pulse');
                } else {
                    btn.classList.remove('text-red-600', 'animate-pulse');
                }
            });
        }

        // --- CORE FUNCTIONS ---

        function init() {
            initSpeechRecognition();
            const urlParams = new URLSearchParams(window.location.search);
            currentBlockIndex = Math.max(0, Math.min((parseInt(urlParams.get('block')) || 1) - 1, questionnaireBlocks.length - 1));

            // Check Lock logic
            const block1Locked = localStorage.getItem('block1Locked') === 'true';
            if (block1Locked) questionnaireBlocks[0].isLocked = true;

            loadBlock(currentBlockIndex);
            updateSidebar();
        }

        function loadBlock(index) {
            const block = questionnaireBlocks[index];
            currentBlockIndex = index;

            // Render Header
            const headerDiv = document.getElementById('block-header');
            headerDiv.innerHTML = `
                <span class=" text-xs uppercase tracking-[0.3em] text-plum mb-2 block">Step ${index + 1} of ${questionnaireBlocks.length}</span>
                <h1 class="font-goldney text-4xl md:text-5xl text-charcoal mb-4">${block.title}</h1>
                <p class=" text-lg text-taupe leading-relaxed">${block.instruction}</p>
            `;

            // Render Questions
            renderQuestions(block);
            updateNavButtons(block);
            updateSidebar();
        }

        function renderQuestions(block) {
            const container = document.getElementById('inputs-container');
            container.innerHTML = '';

            let firstUnansweredFound = false;

            block.questions.forEach((q, idx) => {
                const savedAnswer = localStorage.getItem(`block${block.id}_${q.id}`) || '';
                const isAnswered = savedAnswer.trim() !== '';
                const isLocked = block.isLocked && block.id === 1;

                // Determine State
                // 1. Editing: Manually triggered
                // 2. Answered: Show display
                // 3. Active: First unanswered
                // 4. Pending: Subsequent unanswered

                let mode = 'pending';
                if (editingQuestionId === q.id) {
                    mode = 'editing';
                } else if (isAnswered) {
                    mode = 'answered';
                } else if (!firstUnansweredFound) {
                    mode = 'active';
                    firstUnansweredFound = true;
                    activeQuestionId = q.id;
                }

                const el = document.createElement('div');
                el.className = `transition-all duration-500 ${mode === 'pending' ? 'opacity-40 grayscale' : 'opacity-100'}`;

                // Question Text
                const qText = `<h3 class="font-goldney text-2xl text-charcoal mb-4"><span class="text-plum text-lg mr-2">${idx + 1}.</span> ${q.text}</h3>`;

                if (mode === 'answered') {
                    // DISPLAY MODE
                    el.innerHTML = `
                        ${qText}
                        <div class="bg-white p-6 border-l-4 border-plum shadow-sm relative group">
                            <p class=" text-taupe leading-relaxed whitespace-pre-wrap">${savedAnswer}</p>
                            ${!isLocked ? `
                                <button onclick="startEditing('${q.id}')" class="absolute top-4 right-4 text-xs  uppercase tracking-widest text-taupe hover:text-plum opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    Edit
                                </button>
                            ` : ''}
                        </div>
                    `;
                } else if (mode === 'active' || mode === 'editing') {
                    // INPUT MODE
                    const inputId = `input-${q.id}`;
                    const val = mode === 'editing' ? savedAnswer : '';

                    const inputHtml = q.type === 'textarea'
                        ? `<textarea id="${inputId}" rows="4" maxlength="1500" placeholder="${q.placeholder}" class="w-full bg-white border border-beige p-4 focus:border-plum outline-none  text-charcoal resize-none rounded">${val}</textarea>`
                        : `<input type="text" id="${inputId}" maxlength="1500" placeholder="${q.placeholder}" value="${val}" class="w-full bg-white border border-beige p-4 focus:border-plum outline-none  text-charcoal rounded">`;

                    el.innerHTML = `
                        ${qText}
                        <div class="relative animate-[fadeIn_0.3s]">
                            ${inputHtml}
                            <div class="flex justify-between items-center mt-2 px-1">
                                <span class="text-[10px] text-taupe uppercase tracking-widest char-count" data-for="${inputId}">0/1500</span>
                                <div class="flex gap-4">
                                     <button type="button" class="voice-btn text-taupe hover:text-plum transition-colors" data-target="${inputId}" onclick="toggleVoiceInput('${inputId}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                                    </button>
                                    <button onclick="saveAnswer('${q.id}')" class="bg-plum text-white  text-[10px] uppercase tracking-[0.2em] px-6 py-2 hover:bg-plum-light transition-colors rounded">
                                        ${mode === 'editing' ? 'Update' : 'Confirm'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    // Attach event listener deferred
                    setTimeout(() => {
                        const inp = document.getElementById(inputId);
                        if (inp) {
                            inp.addEventListener('input', updateCharCount);
                            // Initial count
                            inp.dispatchEvent(new Event('input'));
                            inp.focus();
                        }
                    }, 0);

                } else {
                    // PENDING MODE
                    el.innerHTML = `
                        ${qText}
                        <div class="border-b border-beige pb-2">
                             <span class=" text-sm text-taupe italic">Upcoming...</span>
                        </div>
                    `;
                }

                container.appendChild(el);
            });
        }

        // --- ACTIONS ---

        function startEditing(qId) {
            editingQuestionId = qId;
            renderQuestions(questionnaireBlocks[currentBlockIndex]);
        }

        function saveAnswer(qId) {
            const inputId = `input-${qId}`;
            const input = document.getElementById(inputId);
            if (!input) return;

            const val = input.value.trim();
            if (!val) { alert("Please provide an answer."); return; }

            const block = questionnaireBlocks[currentBlockIndex];
            localStorage.setItem(`block${block.id}_${qId}`, val);

            // Reset editing state
            editingQuestionId = null;

            // Re-render
            loadBlock(currentBlockIndex);
        }

        function updateCharCount(e) {
            const id = e.target.id;
            const countDisplay = document.querySelector(`.char-count[data-for="${id}"]`);
            if (countDisplay) {
                countDisplay.textContent = `${e.target.value.length}/1500`;
                if (e.target.value.length > 1400) countDisplay.classList.add('text-red-600');
                else countDisplay.classList.remove('text-red-600');
            }
        }

        function isBlockComplete(block) {
            return block.questions.every(q => {
                const saved = localStorage.getItem(`block${block.id}_${q.id}`) || '';
                return saved.trim() !== '';
            });
        }

        // --- NAVIGATION ---

        function goToNextBlock() {
            const block = questionnaireBlocks[currentBlockIndex];
            if (!isBlockComplete(block)) { alert("Please answer all questions."); return; }

            if (currentBlockIndex === 0 && !block.isLocked) {
                localStorage.setItem('block1Locked', 'true');
            }

            if (currentBlockIndex < questionnaireBlocks.length - 1) {
                window.location.search = `?block=${currentBlockIndex + 2}`;
            } else {
                window.location.href = 'filters.html';
            }
        }

        function goToPreviousBlock() {
            if (currentBlockIndex > 0) {
                window.location.search = `?block=${currentBlockIndex}`;
            }
        }

        function updateNavButtons(block) {
            const nextBtn = document.getElementById('next-button');
            const backBtn = document.getElementById('back-button');

            backBtn.disabled = currentBlockIndex === 0;
            backBtn.style.opacity = currentBlockIndex === 0 ? '0' : '1';

            nextBtn.disabled = !isBlockComplete(block);
            nextBtn.innerHTML = currentBlockIndex === questionnaireBlocks.length - 1 ? 'Finish Interview' : 'Next Block';
        }

        function updateSidebar() {
            const container = document.getElementById('sidebar-steps');
            container.innerHTML = '<div class="absolute left-[15px] top-2 bottom-2 w-px bg-border -z-10"></div>';

            let completedBlocks = 0;

            questionnaireBlocks.forEach((b, idx) => {
                const isActive = idx === currentBlockIndex;
                const isComplete = isBlockComplete(b);
                if (isComplete) completedBlocks++;

                // Status Icon
                let iconHtml = '';
                if (isActive) iconHtml = `<div class="w-8 h-8 rounded-full bg-plum text-white flex items-center justify-center border-4 border-white shadow-sm font-goldney relative z-10">${idx + 1}</div>`;
                else if (isComplete) iconHtml = `<div class="w-8 h-8 rounded-full bg-cream text-plum border border-plum flex items-center justify-center font-goldney relative z-10">✓</div>`;
                else iconHtml = `<div class="w-8 h-8 rounded-full bg-white border border-beige text-taupe flex items-center justify-center font-goldney relative z-10">${idx + 1}</div>`;

                const el = document.createElement('div');
                el.className = `flex items-center gap-4 cursor-pointer group ${isActive ? 'opacity-100' : 'opacity-60 hover:opacity-100'}`;
                el.onclick = () => { if (isComplete || idx < currentBlockIndex) window.location.search = `?block=${idx + 1}`; };

                el.innerHTML = `
                    ${iconHtml}
                    <div class="flex flex-col">
                        <span class=" text-[10px] uppercase tracking-widest text-taupe">Step 0${idx + 1}</span>
                        <span class="font-goldney text-lg text-charcoal group-hover:text-plum transition-colors">${b.title}</span>
                    </div>
                `;
                container.appendChild(el);
            });

            // Progress
            const pct = Math.round((completedBlocks / questionnaireBlocks.length) * 100);
            document.getElementById('sidebar-progress-text').textContent = `${pct}%`;
            document.getElementById('sidebar-progress-bar').style.width = `${pct}%`;
            document.getElementById('mobile-progress').textContent = `${pct}%`;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>

</html>